'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.errorCodes = undefined;
exports.createExpressMiddleware = createExpressMiddleware;

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _util = require('./util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var errorCodes = exports.errorCodes = {
  NO_BODY_PARSER: 'SLACKEVENTMIDDLEWARE_NO_BODY_PARSER',
  TOKEN_VERIFICATION_FAILURE: 'SLACKEVENTMIDDLEWARE_TOKEN_VERIFICATION_FAILURE'
};

var responseStatuses = {
  OK: 200,
  FAILURE: 500,
  REDIRECT: 302
};

var debug = (0, _debug2.default)('@slack/events-api:express-middleware');

function createExpressMiddleware(adapter) {
  var middlewareOptions = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  // This function binds a specific response instance to a function that works more like a
  // a completion handler; one which follows the error-first argument pattern.
  function sendResponse(res) {
    // This function is the completion handler for sending a response to an event. It can either
    // be invoked by automatically or by the user (when using the `waitForResponse` option).
    return function _sendResponse(err) {
      var responseOptions = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      debug('sending response - error: %s, responseOptions: %o', err, responseOptions);
      // Deal with errors up front
      if (err) {
        res.status(responseStatuses.FAILURE);
      } else {
        // First determine the response status
        if (responseOptions) {
          if (responseOptions.failWithNoRetry) {
            res.status(responseStatuses.FAILURE);
          } else if (responseOptions.redirectLocation) {
            res.status(responseStatuses.REDIRECT);
          }
        } else {
          res.status(responseStatuses.OK);
        }

        // Next determine the response headers
        if (responseOptions && responseOptions.failWithNoRetry) {
          res.set('X-Slack-No-Retry', '1');
        }
        res.set('X-Slack-Powered-By', (0, _util.packageIdentifier)());
      }

      // Lastly, send the response
      var content = responseOptions.content || '';
      debug('response body: %s', content);
      res.send(content);
      res.on('finish', function () {
        // res._headers is an undocumented property, but we feel comfortable using it because:
        // 1. express depends on it and express is so foundational in node
        // 2. this is logging code and the risk of this causing a break is minimal
        // eslint-disable-next-line no-underscore-dangle
        debug('response finished - status: %d, headers: %o', res.statusCode, res._headers);
      });
    };
  }

  // This function abstracts handling of an error. It inspects the relevant options to dispatch the
  // error using the right interface (either the next middleware or emitted from
  // the adapter) and handles the respond function.
  function handleError(error, respond, next) {
    debug('handling error - message: %s, code: %s', error.message, error.code);
    if (middlewareOptions.propagateErrors) {
      debug('propagating error for next middleware');
      // The respond function is never invoked because the next middleware is expected to respond
      next(error);
      return;
    }
    try {
      if (adapter.waitForResponse) {
        adapter.emit('error', error, respond);
      } else {
        adapter.emit('error', error);
        respond(error);
      }
    } catch (userError) {
      process.nextTick(function () {
        throw userError;
      });
    }
  }

  return function slackEventAdapterMiddleware(req, res, next) {
    debug('request recieved - method: %s, path: %s', req.method, req.path);

    // Bind a response function to this request's respond object. This may be used in a number of
    // places
    var respond = sendResponse(res);

    // Check that the request body has been parsed
    if (!req.body) {
      var error = new Error('The incoming HTTP request did not have a parsed body.');
      error.code = errorCodes.NO_BODY_PARSER;
      handleError(error, respond, next);
      return;
    }

    // Handle URL verification challenge
    if (req.body.type === 'url_verification') {
      debug('handling url verification');
      if (req.body.token !== adapter.verificationToken) {
        debug('url verification failure');
        var _error = new Error('Slack event challenge failed.');
        _error.code = errorCodes.TOKEN_VERIFICATION_FAILURE;
        _error.body = req.body;
        handleError(_error, respond, next);
        return;
      }
      debug('url verification success');
      respond(null, { content: req.body.challenge });
      return;
    }

    // Handle request token verification
    if (!req.body.token || req.body.token !== adapter.verificationToken) {
      debug('request token verification failure');
      var _error2 = new Error('Slack event verification failed');
      _error2.code = errorCodes.TOKEN_VERIFICATION_FAILURE;
      _error2.body = req.body;
      handleError(_error2, respond, next);
      return;
    }
    debug('request token verification success');

    var emitArguments = [req.body.event];
    if (adapter.includeBody) {
      emitArguments.push(req.body);
    }
    if (adapter.includeHeaders) {
      emitArguments.push(req.headers);
    }
    if (adapter.waitForResponse) {
      emitArguments.push(respond);
    } else {
      respond();
    }

    try {
      debug('emitting event -  type: %s, arguments: %o', req.body.event.type, emitArguments);
      adapter.emit.apply(adapter, [req.body.event.type].concat(emitArguments));
    } catch (error) {
      handleError(error, respond, next);
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzLW1pZGRsZXdhcmUuanMiXSwibmFtZXMiOlsiY3JlYXRlRXhwcmVzc01pZGRsZXdhcmUiLCJlcnJvckNvZGVzIiwiTk9fQk9EWV9QQVJTRVIiLCJUT0tFTl9WRVJJRklDQVRJT05fRkFJTFVSRSIsInJlc3BvbnNlU3RhdHVzZXMiLCJPSyIsIkZBSUxVUkUiLCJSRURJUkVDVCIsImRlYnVnIiwiYWRhcHRlciIsIm1pZGRsZXdhcmVPcHRpb25zIiwic2VuZFJlc3BvbnNlIiwicmVzIiwiX3NlbmRSZXNwb25zZSIsImVyciIsInJlc3BvbnNlT3B0aW9ucyIsInN0YXR1cyIsImZhaWxXaXRoTm9SZXRyeSIsInJlZGlyZWN0TG9jYXRpb24iLCJzZXQiLCJjb250ZW50Iiwic2VuZCIsIm9uIiwic3RhdHVzQ29kZSIsIl9oZWFkZXJzIiwiaGFuZGxlRXJyb3IiLCJlcnJvciIsInJlc3BvbmQiLCJuZXh0IiwibWVzc2FnZSIsImNvZGUiLCJwcm9wYWdhdGVFcnJvcnMiLCJ3YWl0Rm9yUmVzcG9uc2UiLCJlbWl0IiwidXNlckVycm9yIiwicHJvY2VzcyIsIm5leHRUaWNrIiwic2xhY2tFdmVudEFkYXB0ZXJNaWRkbGV3YXJlIiwicmVxIiwibWV0aG9kIiwicGF0aCIsImJvZHkiLCJFcnJvciIsInR5cGUiLCJ0b2tlbiIsInZlcmlmaWNhdGlvblRva2VuIiwiY2hhbGxlbmdlIiwiZW1pdEFyZ3VtZW50cyIsImV2ZW50IiwiaW5jbHVkZUJvZHkiLCJwdXNoIiwiaW5jbHVkZUhlYWRlcnMiLCJoZWFkZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7UUFnQmdCQSx1QixHQUFBQSx1Qjs7QUFoQmhCOzs7O0FBQ0E7Ozs7QUFFTyxJQUFNQyxrQ0FBYTtBQUN4QkMsa0JBQWdCLHFDQURRO0FBRXhCQyw4QkFBNEI7QUFGSixDQUFuQjs7QUFLUCxJQUFNQyxtQkFBbUI7QUFDdkJDLE1BQUksR0FEbUI7QUFFdkJDLFdBQVMsR0FGYztBQUd2QkMsWUFBVTtBQUhh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SWhDLFFBQVEwQyxjQUFaLEVBQTRCO0FBQzFCSixvQkFBY0csSUFBZCxDQUFtQlosSUFBSWMsT0FBdkI7QUFDRDtBQUNELFFBQUkzQyxRQUFRdUIsZUFBWixFQUE2QjtBQUMzQmUsb0JBQWNHLElBQWQsQ0FBbUJ2QixPQUFuQjtBQUNELEtBRkQsTUFFTztBQUNMQTtBQUNEOztBQUVELFFBQUk7QUFDRm5CLFlBQU0sMkNBQU4sRUFBbUQ4QixJQUFJRyxJQUFKLENBQVNPLEtBQVQsQ0FBZUwsSUFBbEUsRUFBd0VJLGFBQXhFO0FBQ0F0QyxjQUFRd0IsSUFBUixpQkFBYUssSUFBSUcsSUFBSixDQUFTTyxLQUFULENBQWVMLElBQTVCLFNBQXFDSSxhQUFyQztBQUNELEtBSEQsQ0FHRSxPQUFPckIsS0FBUCxFQUFjO0FBQ2RELGtCQUFZQyxLQUFaLEVBQW1CQyxPQUFuQixFQUE0QkMsSUFBNUI7QUFDRDtBQUNGLEdBN0REO0FBOEREIiwiZmlsZSI6ImV4cHJlc3MtbWlkZGxld2FyZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1Z0ZhY3RvcnkgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgcGFja2FnZUlkZW50aWZpZXIgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgY29uc3QgZXJyb3JDb2RlcyA9IHtcbiAgTk9fQk9EWV9QQVJTRVI6ICdTTEFDS0VWRU5UTUlERExFV0FSRV9OT19CT0RZX1BBUlNFUicsXG4gIFRPS0VOX1ZFUklGSUNBVElPTl9GQUlMVVJFOiAnU0xBQ0tFVkVOVE1JRERMRVdBUkVfVE9LRU5fVkVSSUZJQ0FUSU9OX0ZBSUxVUkUnLFxufTtcblxuY29uc3QgcmVzcG9uc2VTdGF0dXNlcyA9IHtcbiAgT0s6IDIwMCxcbiAgRkFJTFVSRTogNTAwLFxuICBSRURJUkVDVDogMzAyLFxufTtcblxuY29uc3QgZGVidWcgPSBkZWJ1Z0ZhY3RvcnkoJ0BzbGFjay9ldmVudHMtYXBpOmV4cHJlc3MtbWlkZGxld2FyZScpO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRXhwcmVzc01pZGRsZXdhcmUoYWRhcHRlciwgbWlkZGxld2FyZU9wdGlvbnMgPSB7fSkge1xuICAvLyBUaGlzIGZ1bmN0aW9uIGJpbmRzIGEgc3BlY2lmaWMgcmVzcG9uc2UgaW5zdGFuY2UgdG8gYSBmdW5jdGlvbiB0aGF0IHdvcmtzIG1vcmUgbGlrZSBhXG4gIC8vIGEgY29tcGxldGlvbiBoYW5kbGVyOyBvbmUgd2hpY2ggZm9sbG93cyB0aGUgZXJyb3ItZmlyc3QgYXJndW1lbnQgcGF0dGVybi5cbiAgZnVuY3Rpb24gc2VuZFJlc3BvbnNlKHJlcykge1xuICAgIC8vIFRoaXMgZnVuY3Rpb24gaXMgdGhlIGNvbXBsZXRpb24gaGFuZGxlciBmb3Igc2VuZGluZyBhIHJlc3BvbnNlIHRvIGFuIGV2ZW50LiBJdCBjYW4gZWl0aGVyXG4gICAgLy8gYmUgaW52b2tlZCBieSBhdXRvbWF0aWNhbGx5IG9yIGJ5IHRoZSB1c2VyICh3aGVuIHVzaW5nIHRoZSBgd2FpdEZvclJlc3BvbnNlYCBvcHRpb24pLlxuICAgIHJldHVybiBmdW5jdGlvbiBfc2VuZFJlc3BvbnNlKGVyciwgcmVzcG9uc2VPcHRpb25zID0ge30pIHtcbiAgICAgIGRlYnVnKCdzZW5kaW5nIHJlc3BvbnNlIC0gZXJyb3I6ICVzLCByZXNwb25zZU9wdGlvbnM6ICVvJywgZXJyLCByZXNwb25zZU9wdGlvbnMpO1xuICAgICAgLy8gRGVhbCB3aXRoIGVycm9ycyB1cCBmcm9udFxuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXMuc3RhdHVzKHJlc3BvbnNlU3RhdHVzZXMuRkFJTFVSRSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGaXJzdCBkZXRlcm1pbmUgdGhlIHJlc3BvbnNlIHN0YXR1c1xuICAgICAgICBpZiAocmVzcG9uc2VPcHRpb25zKSB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlT3B0aW9ucy5mYWlsV2l0aE5vUmV0cnkpIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMocmVzcG9uc2VTdGF0dXNlcy5GQUlMVVJFKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlT3B0aW9ucy5yZWRpcmVjdExvY2F0aW9uKSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKHJlc3BvbnNlU3RhdHVzZXMuUkVESVJFQ1QpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuc3RhdHVzKHJlc3BvbnNlU3RhdHVzZXMuT0spO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTmV4dCBkZXRlcm1pbmUgdGhlIHJlc3BvbnNlIGhlYWRlcnNcbiAgICAgICAgaWYgKHJlc3BvbnNlT3B0aW9ucyAmJiByZXNwb25zZU9wdGlvbnMuZmFpbFdpdGhOb1JldHJ5KSB7XG4gICAgICAgICAgcmVzLnNldCgnWC1TbGFjay1Oby1SZXRyeScsICcxJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzLnNldCgnWC1TbGFjay1Qb3dlcmVkLUJ5JywgcGFja2FnZUlkZW50aWZpZXIoKSk7XG4gICAgICB9XG5cbiAgICAgIC8vIExhc3RseSwgc2VuZCB0aGUgcmVzcG9uc2VcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSByZXNwb25zZU9wdGlvbnMuY29udGVudCB8fCAnJztcbiAgICAgIGRlYnVnKCdyZXNwb25zZSBib2R5OiAlcycsIGNvbnRlbnQpO1xuICAgICAgcmVzLnNlbmQoY29udGVudCk7XG4gICAgICByZXMub24oJ2ZpbmlzaCcsICgpID0+IHtcbiAgICAgICAgLy8gcmVzLl9oZWFkZXJzIGlzIGFuIHVuZG9jdW1lbnRlZCBwcm9wZXJ0eSwgYnV0IHdlIGZlZWwgY29tZm9ydGFibGUgdXNpbmcgaXQgYmVjYXVzZTpcbiAgICAgICAgLy8gMS4gZXhwcmVzcyBkZXBlbmRzIG9uIGl0IGFuZCBleHByZXNzIGlzIHNvIGZvdW5kYXRpb25hbCBpbiBub2RlXG4gICAgICAgIC8vIDIuIHRoaXMgaXMgbG9nZ2luZyBjb2RlIGFuZCB0aGUgcmlzayBvZiB0aGlzIGNhdXNpbmcgYSBicmVhayBpcyBtaW5pbWFsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgICAgICBkZWJ1ZygncmVzcG9uc2UgZmluaXNoZWQgLSBzdGF0dXM6ICVkLCBoZWFkZXJzOiAlbycsIHJlcy5zdGF0dXNDb2RlLCByZXMuX2hlYWRlcnMpO1xuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIC8vIFRoaXMgZnVuY3Rpb24gYWJzdHJhY3RzIGhhbmRsaW5nIG9mIGFuIGVycm9yLiBJdCBpbnNwZWN0cyB0aGUgcmVsZXZhbnQgb3B0aW9ucyB0byBkaXNwYXRjaCB0aGVcbiAgLy8gZXJyb3IgdXNpbmcgdGhlIHJpZ2h0IGludGVyZmFjZSAoZWl0aGVyIHRoZSBuZXh0IG1pZGRsZXdhcmUgb3IgZW1pdHRlZCBmcm9tXG4gIC8vIHRoZSBhZGFwdGVyKSBhbmQgaGFuZGxlcyB0aGUgcmVzcG9uZCBmdW5jdGlvbi5cbiAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3IsIHJlc3BvbmQsIG5leHQpIHtcbiAgICBkZWJ1ZygnaGFuZGxpbmcgZXJyb3IgLSBtZXNzYWdlOiAlcywgY29kZTogJXMnLCBlcnJvci5tZXNzYWdlLCBlcnJvci5jb2RlKTtcbiAgICBpZiAobWlkZGxld2FyZU9wdGlvbnMucHJvcGFnYXRlRXJyb3JzKSB7XG4gICAgICBkZWJ1ZygncHJvcGFnYXRpbmcgZXJyb3IgZm9yIG5leHQgbWlkZGxld2FyZScpO1xuICAgICAgLy8gVGhlIHJlc3BvbmQgZnVuY3Rpb24gaXMgbmV2ZXIgaW52b2tlZCBiZWNhdXNlIHRoZSBuZXh0IG1pZGRsZXdhcmUgaXMgZXhwZWN0ZWQgdG8gcmVzcG9uZFxuICAgICAgbmV4dChlcnJvcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBpZiAoYWRhcHRlci53YWl0Rm9yUmVzcG9uc2UpIHtcbiAgICAgICAgYWRhcHRlci5lbWl0KCdlcnJvcicsIGVycm9yLCByZXNwb25kKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvcik7XG4gICAgICAgIHJlc3BvbmQoZXJyb3IpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKHVzZXJFcnJvcikge1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7IHRocm93IHVzZXJFcnJvcjsgfSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIHNsYWNrRXZlbnRBZGFwdGVyTWlkZGxld2FyZShyZXEsIHJlcywgbmV4dCkge1xuICAgIGRlYnVnKCdyZXF1ZXN0IHJlY2lldmVkIC0gbWV0aG9kOiAlcywgcGF0aDogJXMnLCByZXEubWV0aG9kLCByZXEucGF0aCk7XG5cbiAgICAvLyBCaW5kIGEgcmVzcG9uc2UgZnVuY3Rpb24gdG8gdGhpcyByZXF1ZXN0J3MgcmVzcG9uZCBvYmplY3QuIFRoaXMgbWF5IGJlIHVzZWQgaW4gYSBudW1iZXIgb2ZcbiAgICAvLyBwbGFjZXNcbiAgICBjb25zdCByZXNwb25kID0gc2VuZFJlc3BvbnNlKHJlcyk7XG5cbiAgICAvLyBDaGVjayB0aGF0IHRoZSByZXF1ZXN0IGJvZHkgaGFzIGJlZW4gcGFyc2VkXG4gICAgaWYgKCFyZXEuYm9keSkge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1RoZSBpbmNvbWluZyBIVFRQIHJlcXVlc3QgZGlkIG5vdCBoYXZlIGEgcGFyc2VkIGJvZHkuJyk7XG4gICAgICBlcnJvci5jb2RlID0gZXJyb3JDb2Rlcy5OT19CT0RZX1BBUlNFUjtcbiAgICAgIGhhbmRsZUVycm9yKGVycm9yLCByZXNwb25kLCBuZXh0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgVVJMIHZlcmlmaWNhdGlvbiBjaGFsbGVuZ2VcbiAgICBpZiAocmVxLmJvZHkudHlwZSA9PT0gJ3VybF92ZXJpZmljYXRpb24nKSB7XG4gICAgICBkZWJ1ZygnaGFuZGxpbmcgdXJsIHZlcmlmaWNhdGlvbicpO1xuICAgICAgaWYgKHJlcS5ib2R5LnRva2VuICE9PSBhZGFwdGVyLnZlcmlmaWNhdGlvblRva2VuKSB7XG4gICAgICAgIGRlYnVnKCd1cmwgdmVyaWZpY2F0aW9uIGZhaWx1cmUnKTtcbiAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1NsYWNrIGV2ZW50IGNoYWxsZW5nZSBmYWlsZWQuJyk7XG4gICAgICAgIGVycm9yLmNvZGUgPSBlcnJvckNvZGVzLlRPS0VOX1ZFUklGSUNBVElPTl9GQUlMVVJFO1xuICAgICAgICBlcnJvci5ib2R5ID0gcmVxLmJvZHk7XG4gICAgICAgIGhhbmRsZUVycm9yKGVycm9yLCByZXNwb25kLCBuZXh0KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZGVidWcoJ3VybCB2ZXJpZmljYXRpb24gc3VjY2VzcycpO1xuICAgICAgcmVzcG9uZChudWxsLCB7IGNvbnRlbnQ6IHJlcS5ib2R5LmNoYWxsZW5nZSB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgcmVxdWVzdCB0b2tlbiB2ZXJpZmljYXRpb25cbiAgICBpZiAoIXJlcS5ib2R5LnRva2VuIHx8IHJlcS5ib2R5LnRva2VuICE9PSBhZGFwdGVyLnZlcmlmaWNhdGlvblRva2VuKSB7XG4gICAgICBkZWJ1ZygncmVxdWVzdCB0b2tlbiB2ZXJpZmljYXRpb24gZmFpbHVyZScpO1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1NsYWNrIGV2ZW50IHZlcmlmaWNhdGlvbiBmYWlsZWQnKTtcbiAgICAgIGVycm9yLmNvZGUgPSBlcnJvckNvZGVzLlRPS0VOX1ZFUklGSUNBVElPTl9GQUlMVVJFO1xuICAgICAgZXJyb3IuYm9keSA9IHJlcS5ib2R5O1xuICAgICAgaGFuZGxlRXJyb3IoZXJyb3IsIHJlc3BvbmQsIG5leHQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWJ1ZygncmVxdWVzdCB0b2tlbiB2ZXJpZmljYXRpb24gc3VjY2VzcycpO1xuXG4gICAgY29uc3QgZW1pdEFyZ3VtZW50cyA9IFtyZXEuYm9keS5ldmVudF07XG4gICAgaWYgKGFkYXB0ZXIuaW5jbHVkZUJvZHkpIHtcbiAgICAgIGVtaXRBcmd1bWVudHMucHVzaChyZXEuYm9keSk7XG4gICAgfVxuICAgIGlmIChhZGFwdGVyLmluY2x1ZGVIZWFkZXJzKSB7XG4gICAgICBlbWl0QXJndW1lbnRzLnB1c2gocmVxLmhlYWRlcnMpO1xuICAgIH1cbiAgICBpZiAoYWRhcHRlci53YWl0Rm9yUmVzcG9uc2UpIHtcbiAgICAgIGVtaXRBcmd1bWVudHMucHVzaChyZXNwb25kKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzcG9uZCgpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBkZWJ1ZygnZW1pdHRpbmcgZXZlbnQgLSAgdHlwZTogJXMsIGFyZ3VtZW50czogJW8nLCByZXEuYm9keS5ldmVudC50eXBlLCBlbWl0QXJndW1lbnRzKTtcbiAgICAgIGFkYXB0ZXIuZW1pdChyZXEuYm9keS5ldmVudC50eXBlLCAuLi5lbWl0QXJndW1lbnRzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaGFuZGxlRXJyb3IoZXJyb3IsIHJlc3BvbmQsIG5leHQpO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==
//# sourceMappingURL=express-middleware.js.map