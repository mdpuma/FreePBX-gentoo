'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.errorCodes = undefined;

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

exports.verifyRequestSignature = verifyRequestSignature;
exports.createHTTPHandler = createHTTPHandler;

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _rawBody = require('raw-body');

var _rawBody2 = _interopRequireDefault(_rawBody);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _tsscmp = require('tsscmp');

var _tsscmp2 = _interopRequireDefault(_tsscmp);

var _util = require('./util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var errorCodes = exports.errorCodes = {
  SIGNATURE_VERIFICATION_FAILURE: 'SLACKHTTPHANDLER_REQUEST_SIGNATURE_VERIFICATION_FAILURE',
  REQUEST_TIME_FAILURE: 'SLACKHTTPHANDLER_REQUEST_TIMELIMIT_FAILURE'
};

var responseStatuses = {
  OK: 200,
  FAILURE: 500,
  REDIRECT: 302,
  NOT_FOUND: 404
};

var debug = (0, _debug2.default)('@slack/events-api:http-handler');

/**
 * Method to verify signature of requests
 *
 * @param {string} signingSecret - Signing secret used to verify request signature
 * @param {string} requestSignature - Signature from request 'x-slack-signature' header
 * @param {number} requestTimestamp - Timestamp from request 'x-slack-request-timestamp' header
 * @param {string} body - Raw body string
 * @returns {boolean} Indicates if request is verified
 */
function verifyRequestSignature(_ref) {
  var signingSecret = _ref.signingSecret,
      requestSignature = _ref.requestSignature,
      requestTimestamp = _ref.requestTimestamp,
      body = _ref.body;

  // Divide current date to match Slack ts format
  // Subtract 5 minutes from current time
  var fiveMinutesAgo = Math.floor(Date.now() / 1000) - 60 * 5;

  if (requestTimestamp < fiveMinutesAgo) {
    debug('request is older than 5 minutes');
    var error = new Error('Slack request signing verification failed');
    error.code = errorCodes.REQUEST_TIME_FAILURE;
    throw error;
  }

  var hmac = _crypto2.default.createHmac('sha256', signingSecret);

  var _requestSignature$spl = requestSignature.split('='),
      _requestSignature$spl2 = _slicedToArray(_requestSignature$spl, 2),
      version = _requestSignature$spl2[0],
      hash = _requestSignature$spl2[1];

  hmac.update(version + ':' + requestTimestamp + ':' + body);

  if (!(0, _tsscmp2.default)(hash, hmac.digest('hex'))) {
    debug('request signature is not valid');
    var _error = new Error('Slack request signing verification failed');
    _error.code = errorCodes.SIGNATURE_VERIFICATION_FAILURE;
    throw _error;
  }

  debug('request signing verification success');
  return true;
}

function createHTTPHandler(adapter) {
  var poweredBy = (0, _util.packageIdentifier)();

  /**
   * Binds a specific response instance to the function that works like a
   * completion handler
   *
   * @param {Object} res - Response object
   * @returns {Function} Returns a function used to send response
   */
  function sendResponse(res) {
    // This function is the completion handler for sending a response to an event. It can either
    // be invoked by automatically or by the user (when using the `waitForResponse` option).
    return function _sendResponse(err, responseOptions) {
      debug('sending response - error: %s, responseOptions: %o', err, responseOptions);
      // Deal with errors up front
      if (err) {
        if (err.status) {
          res.statusCode = err.status;
        } else if (err.code === errorCodes.SIGNATURE_VERIFICATION_FAILURE || err.code === errorCodes.REQUEST_TIME_FAILURE) {
          res.statusCode = responseStatuses.NOT_FOUND;
        } else {
          res.statusCode = responseStatuses.FAILURE;
        }
      } else {
        // First determine the response status
        if (responseOptions) {
          if (responseOptions.failWithNoRetry) {
            res.statusCode = responseStatuses.FAILURE;
          } else if (responseOptions.redirectLocation) {
            res.statusCode = responseStatuses.REDIRECT;
          } else {
            // URL Verification
            res.statusCode = responseStatuses.OK;
          }
        } else {
          res.statusCode = responseStatuses.OK;
        }

        // Next determine the response headers
        if (responseOptions && responseOptions.failWithNoRetry) {
          res.setHeader('X-Slack-No-Retry', '1');
        }
        res.setHeader('X-Slack-Powered-By', poweredBy);
      }

      // Lastly, send the response
      if (responseOptions && responseOptions.content) {
        res.end(responseOptions.content);
      } else {
        res.end();
      }
    };
  }

  /**
   * Abstracts error handling.
   *
   * @param {Error} error
   * @param {Function} respond
   */
  function handleError(error, respond) {
    debug('handling error - message: %s, code: %s', error.message, error.code);
    try {
      if (adapter.waitForResponse) {
        adapter.emit('error', error, respond);
      } else if (process.env.NODE_ENV === 'development') {
        adapter.emit('error', error);
        respond({ status: 500 }, { content: error.message });
      } else {
        adapter.emit('error', error);
        respond(error);
      }
    } catch (userError) {
      process.nextTick(function () {
        throw userError;
      });
    }
  }

  /**
   * Request listener used to handle Slack requests and send responses and
   * verify request signatures
   *
   * @param {Object} req - Request object
   * @param {Object} res - Response object
   */
  return function slackEventRequestListener(req, res) {
    debug('request recieved - method: %s, path: %s', req.method, req.url);

    // Bind a response function to this request's respond object.
    var respond = sendResponse(res);

    (0, _rawBody2.default)(req).then(function (r) {
      var rawBody = r.toString();

      if (verifyRequestSignature({
        signingSecret: adapter.signingSecret,
        requestSignature: req.headers['x-slack-signature'],
        requestTimestamp: req.headers['x-slack-request-timestamp'],
        body: rawBody
      })) {
        // Request signature is verified
        // Parse raw body
        var body = JSON.parse(rawBody);

        // Handle URL verification challenge
        if (body.type === 'url_verification') {
          debug('handling url verification');
          respond(null, { content: body.challenge });
          return;
        }

        var emitArguments = [body.event];
        if (adapter.includeBody) {
          emitArguments.push(body);
        }
        if (adapter.includeHeaders) {
          emitArguments.push(req.headers);
        }
        if (adapter.waitForResponse) {
          emitArguments.push(respond);
        } else {
          respond();
        }

        debug('emitting event -  type: %s, arguments: %o', body.event.type, emitArguments);
        adapter.emit.apply(adapter, [body.event.type].concat(emitArguments));
      }
    }).catch(function (error) {
      handleError(error, respond);
    });
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odHRwLWhhbmRsZXIuanMiXSwibmFtZXMiOlsidmVyaWZ5UmVxdWVzdFNpZ25hdHVyZSIsImNyZWF0ZUhUVFBIYW5kbGVyIiwiZXJyb3JDb2RlcyIsIlNJR05BVFVSRV9WRVJJRklDQVRJT05fRkFJTFVSRSIsIlJFUVVFU1RfVElNRV9GQUlMVVJFIiwicmVzcG9uc2VTdGF0dXNlcyIsIk9LIiwiRkFJTFVSRSIsIlJFRElSRUNUIiwiTk9UX0ZPVU5EIiwiZGVidWciLCJzaWduaW5nU2VjcmV0IiwicmVxdWVzdFNpZ25hdHVyZSIsInJlcXVlc3RUaW1lc3RhbXAiLCJib2R5IiwiZml2ZU1pbnV0ZXNBZ28iLCJNYXRoIiwiZmxvb3IiLCJEYXRlIiwibm93IiwiZXJyb3IiLCJFcnJvciIsImNvZGUiLCJobWFjIiwiY3J5cHRvIiwiY3JlYXRlSG1hYyIsInNwbGl0IiwidmVyc2lvbiIsImhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJhZGFwdGVyIiwicG93ZXJlZEJ5Iiwic2VuZFJlc3BvbnNlIiwicmVzIiwiX3NlbmRSZXNwb25zZSIsImVyciIsInJlc3BvbnNlT3B0aW9ucyIsInN0YXR1cyIsInN0YXR1c0NvZGUiLCJmYWlsV2l0aE5vUmV0cnkiLCJyZWRpcmVjdExvY2F0aW9uIiwic2V0SGVhZGVyIiwiY29udGVudCIsImVuZCIsImhhbmRsZUVycm9yIiwicmVzcG9uZCIsIm1lc3NhZ2UiLCJ3YWl0Rm9yUmVzcG9uc2UiLCJlbWl0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwidXNlckVycm9yIiwibmV4dFRpY2siLCJzbGFja0V2ZW50UmVxdWVzdExpc3RlbmVyIiwicmVxIiwibWV0aG9kIiwidXJsIiwidGhlbiIsInIiLCJyYXdCb2R5IiwidG9TdHJpbmciLCJoZWFkZXJzIiwiSlNPTiIsInBhcnNlIiwidHlwZSIsImNoYWxsZW5nZSIsImVtaXRBcmd1bWVudHMiLCJldmVudCIsImluY2x1ZGVCb2R5IiwicHVzaCIsImluY2x1ZGVIZWFk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QUlPLE9BQXZCO0FBQ0Q7QUFDRCxZQUFJaEMsUUFBUWlCLGVBQVosRUFBNkI7QUFDM0JvQix3QkFBY0csSUFBZCxDQUFtQnpCLE9BQW5CO0FBQ0QsU0FGRCxNQUVPO0FBQ0xBO0FBQ0Q7O0FBRURwQyxjQUFNLDJDQUFOLEVBQW1ESSxLQUFLdUQsS0FBTCxDQUFXSCxJQUE5RCxFQUFvRUUsYUFBcEU7QUFDQXJDLGdCQUFRa0IsSUFBUixpQkFBYW5DLEtBQUt1RCxLQUFMLENBQVdILElBQXhCLFNBQWlDRSxhQUFqQztBQUNEO0FBQ0YsS0FyQ0gsRUFxQ0tLLEtBckNMLENBcUNXLFVBQUNyRCxLQUFELEVBQVc7QUFDbEJ5QixrQkFBWXpCLEtBQVosRUFBbUIwQixPQUFuQjtBQUNELEtBdkNIO0FBd0NELEdBOUNEO0FBK0NEIiwiZmlsZSI6Imh0dHAtaGFuZGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1Z0ZhY3RvcnkgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGdldFJhd0JvZHkgZnJvbSAncmF3LWJvZHknO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHRpbWluZ1NhZmVDb21wYXJlIGZyb20gJ3Rzc2NtcCc7XG5pbXBvcnQgeyBwYWNrYWdlSWRlbnRpZmllciB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCBjb25zdCBlcnJvckNvZGVzID0ge1xuICBTSUdOQVRVUkVfVkVSSUZJQ0FUSU9OX0ZBSUxVUkU6ICdTTEFDS0hUVFBIQU5ETEVSX1JFUVVFU1RfU0lHTkFUVVJFX1ZFUklGSUNBVElPTl9GQUlMVVJFJyxcbiAgUkVRVUVTVF9USU1FX0ZBSUxVUkU6ICdTTEFDS0hUVFBIQU5ETEVSX1JFUVVFU1RfVElNRUxJTUlUX0ZBSUxVUkUnLFxufTtcblxuY29uc3QgcmVzcG9uc2VTdGF0dXNlcyA9IHtcbiAgT0s6IDIwMCxcbiAgRkFJTFVSRTogNTAwLFxuICBSRURJUkVDVDogMzAyLFxuICBOT1RfRk9VTkQ6IDQwNCxcbn07XG5cbmNvbnN0IGRlYnVnID0gZGVidWdGYWN0b3J5KCdAc2xhY2svZXZlbnRzLWFwaTpodHRwLWhhbmRsZXInKTtcblxuLyoqXG4gKiBNZXRob2QgdG8gdmVyaWZ5IHNpZ25hdHVyZSBvZiByZXF1ZXN0c1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBzaWduaW5nU2VjcmV0IC0gU2lnbmluZyBzZWNyZXQgdXNlZCB0byB2ZXJpZnkgcmVxdWVzdCBzaWduYXR1cmVcbiAqIEBwYXJhbSB7c3RyaW5nfSByZXF1ZXN0U2lnbmF0dXJlIC0gU2lnbmF0dXJlIGZyb20gcmVxdWVzdCAneC1zbGFjay1zaWduYXR1cmUnIGhlYWRlclxuICogQHBhcmFtIHtudW1iZXJ9IHJlcXVlc3RUaW1lc3RhbXAgLSBUaW1lc3RhbXAgZnJvbSByZXF1ZXN0ICd4LXNsYWNrLXJlcXVlc3QtdGltZXN0YW1wJyBoZWFkZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBib2R5IC0gUmF3IGJvZHkgc3RyaW5nXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gSW5kaWNhdGVzIGlmIHJlcXVlc3QgaXMgdmVyaWZpZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZlcmlmeVJlcXVlc3RTaWduYXR1cmUoe1xuICBzaWduaW5nU2VjcmV0LCByZXF1ZXN0U2lnbmF0dXJlLCByZXF1ZXN0VGltZXN0YW1wLCBib2R5LFxufSkge1xuICAvLyBEaXZpZGUgY3VycmVudCBkYXRlIHRvIG1hdGNoIFNsYWNrIHRzIGZvcm1hdFxuICAvLyBTdWJ0cmFjdCA1IG1pbnV0ZXMgZnJvbSBjdXJyZW50IHRpbWVcbiAgY29uc3QgZml2ZU1pbnV0ZXNBZ28gPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSAtICg2MCAqIDUpO1xuXG4gIGlmIChyZXF1ZXN0VGltZXN0YW1wIDwgZml2ZU1pbnV0ZXNBZ28pIHtcbiAgICBkZWJ1ZygncmVxdWVzdCBpcyBvbGRlciB0aGFuIDUgbWludXRlcycpO1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdTbGFjayByZXF1ZXN0IHNpZ25pbmcgdmVyaWZpY2F0aW9uIGZhaWxlZCcpO1xuICAgIGVycm9yLmNvZGUgPSBlcnJvckNvZGVzLlJFUVVFU1RfVElNRV9GQUlMVVJFO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgY29uc3QgaG1hYyA9IGNyeXB0by5jcmVhdGVIbWFjKCdzaGEyNTYnLCBzaWduaW5nU2VjcmV0KTtcbiAgY29uc3QgW3ZlcnNpb24sIGhhc2hdID0gcmVxdWVzdFNpZ25hdHVyZS5zcGxpdCgnPScpO1xuICBobWFjLnVwZGF0ZShgJHt2ZXJzaW9ufToke3JlcXVlc3RUaW1lc3RhbXB9OiR7Ym9keX1gKTtcblxuICBpZiAoIXRpbWluZ1NhZmVDb21wYXJlKGhhc2gsIGhtYWMuZGlnZXN0KCdoZXgnKSkpIHtcbiAgICBkZWJ1ZygncmVxdWVzdCBzaWduYXR1cmUgaXMgbm90IHZhbGlkJyk7XG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1NsYWNrIHJlcXVlc3Qgc2lnbmluZyB2ZXJpZmljYXRpb24gZmFpbGVkJyk7XG4gICAgZXJyb3IuY29kZSA9IGVycm9yQ29kZXMuU0lHTkFUVVJFX1ZFUklGSUNBVElPTl9GQUlMVVJFO1xuICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgZGVidWcoJ3JlcXVlc3Qgc2lnbmluZyB2ZXJpZmljYXRpb24gc3VjY2VzcycpO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUhUVFBIYW5kbGVyKGFkYXB0ZXIpIHtcbiAgY29uc3QgcG93ZXJlZEJ5ID0gcGFja2FnZUlkZW50aWZpZXIoKTtcblxuICAvKipcbiAgICogQmluZHMgYSBzcGVjaWZpYyByZXNwb25zZSBpbnN0YW5jZSB0byB0aGUgZnVuY3Rpb24gdGhhdCB3b3JrcyBsaWtlIGFcbiAgICogY29tcGxldGlvbiBoYW5kbGVyXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXMgLSBSZXNwb25zZSBvYmplY3RcbiAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIGEgZnVuY3Rpb24gdXNlZCB0byBzZW5kIHJlc3BvbnNlXG4gICAqL1xuICBmdW5jdGlvbiBzZW5kUmVzcG9uc2UocmVzKSB7XG4gICAgLy8gVGhpcyBmdW5jdGlvbiBpcyB0aGUgY29tcGxldGlvbiBoYW5kbGVyIGZvciBzZW5kaW5nIGEgcmVzcG9uc2UgdG8gYW4gZXZlbnQuIEl0IGNhbiBlaXRoZXJcbiAgICAvLyBiZSBpbnZva2VkIGJ5IGF1dG9tYXRpY2FsbHkgb3IgYnkgdGhlIHVzZXIgKHdoZW4gdXNpbmcgdGhlIGB3YWl0Rm9yUmVzcG9uc2VgIG9wdGlvbikuXG4gICAgcmV0dXJuIGZ1bmN0aW9uIF9zZW5kUmVzcG9uc2UoZXJyLCByZXNwb25zZU9wdGlvbnMpIHtcbiAgICAgIGRlYnVnKCdzZW5kaW5nIHJlc3BvbnNlIC0gZXJyb3I6ICVzLCByZXNwb25zZU9wdGlvbnM6ICVvJywgZXJyLCByZXNwb25zZU9wdGlvbnMpO1xuICAgICAgLy8gRGVhbCB3aXRoIGVycm9ycyB1cCBmcm9udFxuICAgICAgaWYgKGVycikge1xuICAgICAgICBpZiAoZXJyLnN0YXR1cykge1xuICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gZXJyLnN0YXR1cztcbiAgICAgICAgfSBlbHNlIGlmIChlcnIuY29kZSA9PT0gZXJyb3JDb2Rlcy5TSUdOQVRVUkVfVkVSSUZJQ0FUSU9OX0ZBSUxVUkUgfHxcbiAgICAgICAgICAgIGVyci5jb2RlID09PSBlcnJvckNvZGVzLlJFUVVFU1RfVElNRV9GQUlMVVJFKSB7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSByZXNwb25zZVN0YXR1c2VzLk5PVF9GT1VORDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IHJlc3BvbnNlU3RhdHVzZXMuRkFJTFVSRTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gRmlyc3QgZGV0ZXJtaW5lIHRoZSByZXNwb25zZSBzdGF0dXNcbiAgICAgICAgaWYgKHJlc3BvbnNlT3B0aW9ucykge1xuICAgICAgICAgIGlmIChyZXNwb25zZU9wdGlvbnMuZmFpbFdpdGhOb1JldHJ5KSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IHJlc3BvbnNlU3RhdHVzZXMuRkFJTFVSRTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlT3B0aW9ucy5yZWRpcmVjdExvY2F0aW9uKSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzQ29kZSA9IHJlc3BvbnNlU3RhdHVzZXMuUkVESVJFQ1Q7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFVSTCBWZXJpZmljYXRpb25cbiAgICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gcmVzcG9uc2VTdGF0dXNlcy5PSztcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSByZXNwb25zZVN0YXR1c2VzLk9LO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTmV4dCBkZXRlcm1pbmUgdGhlIHJlc3BvbnNlIGhlYWRlcnNcbiAgICAgICAgaWYgKHJlc3BvbnNlT3B0aW9ucyAmJiByZXNwb25zZU9wdGlvbnMuZmFpbFdpdGhOb1JldHJ5KSB7XG4gICAgICAgICAgcmVzLnNldEhlYWRlcignWC1TbGFjay1Oby1SZXRyeScsICcxJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzLnNldEhlYWRlcignWC1TbGFjay1Qb3dlcmVkLUJ5JywgcG93ZXJlZEJ5KTtcbiAgICAgIH1cblxuICAgICAgLy8gTGFzdGx5LCBzZW5kIHRoZSByZXNwb25zZVxuICAgICAgaWYgKHJlc3BvbnNlT3B0aW9ucyAmJiByZXNwb25zZU9wdGlvbnMuY29udGVudCkge1xuICAgICAgICByZXMuZW5kKHJlc3BvbnNlT3B0aW9ucy5jb250ZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEFic3RyYWN0cyBlcnJvciBoYW5kbGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtFcnJvcn0gZXJyb3JcbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gcmVzcG9uZFxuICAgKi9cbiAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3IsIHJlc3BvbmQpIHtcbiAgICBkZWJ1ZygnaGFuZGxpbmcgZXJyb3IgLSBtZXNzYWdlOiAlcywgY29kZTogJXMnLCBlcnJvci5tZXNzYWdlLCBlcnJvci5jb2RlKTtcbiAgICB0cnkge1xuICAgICAgaWYgKGFkYXB0ZXIud2FpdEZvclJlc3BvbnNlKSB7XG4gICAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvciwgcmVzcG9uZCk7XG4gICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvcik7XG4gICAgICAgIHJlc3BvbmQoeyBzdGF0dXM6IDUwMCB9LCB7IGNvbnRlbnQ6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhZGFwdGVyLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuICAgICAgICByZXNwb25kKGVycm9yKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoICh1c2VyRXJyb3IpIHtcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4geyB0aHJvdyB1c2VyRXJyb3I7IH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IGxpc3RlbmVyIHVzZWQgdG8gaGFuZGxlIFNsYWNrIHJlcXVlc3RzIGFuZCBzZW5kIHJlc3BvbnNlcyBhbmRcbiAgICogdmVyaWZ5IHJlcXVlc3Qgc2lnbmF0dXJlc1xuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxIC0gUmVxdWVzdCBvYmplY3RcbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcyAtIFJlc3BvbnNlIG9iamVjdFxuICAgKi9cbiAgcmV0dXJuIGZ1bmN0aW9uIHNsYWNrRXZlbnRSZXF1ZXN0TGlzdGVuZXIocmVxLCByZXMpIHtcbiAgICBkZWJ1ZygncmVxdWVzdCByZWNpZXZlZCAtIG1ldGhvZDogJXMsIHBhdGg6ICVzJywgcmVxLm1ldGhvZCwgcmVxLnVybCk7XG5cbiAgICAvLyBCaW5kIGEgcmVzcG9uc2UgZnVuY3Rpb24gdG8gdGhpcyByZXF1ZXN0J3MgcmVzcG9uZCBvYmplY3QuXG4gICAgY29uc3QgcmVzcG9uZCA9IHNlbmRSZXNwb25zZShyZXMpO1xuXG4gICAgZ2V0UmF3Qm9keShyZXEpXG4gICAgICAudGhlbigocikgPT4ge1xuICAgICAgICBjb25zdCByYXdCb2R5ID0gci50b1N0cmluZygpO1xuXG4gICAgICAgIGlmICh2ZXJpZnlSZXF1ZXN0U2lnbmF0dXJlKHtcbiAgICAgICAgICBzaWduaW5nU2VjcmV0OiBhZGFwdGVyLnNpZ25pbmdTZWNyZXQsXG4gICAgICAgICAgcmVxdWVzdFNpZ25hdHVyZTogcmVxLmhlYWRlcnNbJ3gtc2xhY2stc2lnbmF0dXJlJ10sXG4gICAgICAgICAgcmVxdWVzdFRpbWVzdGFtcDogcmVxLmhlYWRlcnNbJ3gtc2xhY2stcmVxdWVzdC10aW1lc3RhbXAnXSxcbiAgICAgICAgICBib2R5OiByYXdCb2R5LFxuICAgICAgICB9KSkge1xuICAgICAgICAgIC8vIFJlcXVlc3Qgc2lnbmF0dXJlIGlzIHZlcmlmaWVkXG4gICAgICAgICAgLy8gUGFyc2UgcmF3IGJvZHlcbiAgICAgICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyYXdCb2R5KTtcblxuICAgICAgICAgIC8vIEhhbmRsZSBVUkwgdmVyaWZpY2F0aW9uIGNoYWxsZW5nZVxuICAgICAgICAgIGlmIChib2R5LnR5cGUgPT09ICd1cmxfdmVyaWZpY2F0aW9uJykge1xuICAgICAgICAgICAgZGVidWcoJ2hhbmRsaW5nIHVybCB2ZXJpZmljYXRpb24nKTtcbiAgICAgICAgICAgIHJlc3BvbmQobnVsbCwgeyBjb250ZW50OiBib2R5LmNoYWxsZW5nZSB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBlbWl0QXJndW1lbnRzID0gW2JvZHkuZXZlbnRdO1xuICAgICAgICAgIGlmIChhZGFwdGVyLmluY2x1ZGVCb2R5KSB7XG4gICAgICAgICAgICBlbWl0QXJndW1lbnRzLnB1c2goYm9keSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhZGFwdGVyLmluY2x1ZGVIZWFkZXJzKSB7XG4gICAgICAgICAgICBlbWl0QXJndW1lbnRzLnB1c2gocmVxLmhlYWRlcnMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYWRhcHRlci53YWl0Rm9yUmVzcG9uc2UpIHtcbiAgICAgICAgICAgIGVtaXRBcmd1bWVudHMucHVzaChyZXNwb25kKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzcG9uZCgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGRlYnVnKCdlbWl0dGluZyBldmVudCAtICB0eXBlOiAlcywgYXJndW1lbnRzOiAlbycsIGJvZHkuZXZlbnQudHlwZSwgZW1pdEFyZ3VtZW50cyk7XG4gICAgICAgICAgYWRhcHRlci5lbWl0KGJvZHkuZXZlbnQudHlwZSwgLi4uZW1pdEFyZ3VtZW50cyk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICBoYW5kbGVFcnJvcihlcnJvciwgcmVzcG9uZCk7XG4gICAgICB9KTtcbiAgfTtcbn1cbiJdfQ==
//# sourceMappingURL=http-handler.js.map