'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.errorCodes = undefined;

var _util = require('./util');

var errorCodes = exports.errorCodes = {
  NO_BODY_PARSER: 'SLACKEVENTMIDDLEWARE_NO_BODY_PARSER',
  TOKEN_VERIFICATION_FAILURE: 'SLACKEVENTMIDDLEWARE_TOKEN_VERIFICATION_FAILURE'
};

var responseStatuses = {
  OK: 200,
  FAILURE: 500,
  REDIRECT: 302
};

function bindMiddlewareToAdapter(adapter) {
  function sendResponse(res) {
    return function _sendResponse(err) {
      var responseOptions = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      // Deal with errors up front
      if (err) {
        res.status(responseStatuses.FAILURE);
      } else {
        // First determine the response status
        if (responseOptions) {
          if (responseOptions.failWithNoRetry) {
            res.status(responseStatuses.FAILURE);
          } else if (responseOptions.redirectLocation) {
            res.status(responseStatuses.REDIRECT);
          }
        } else {
          res.status(responseStatuses.OK);
        }

        // Next determine the response headers
        if (responseOptions && responseOptions.failWithNoRetry) {
          res.set('X-Slack-No-Retry', '1');
        }
        res.set('X-Slack-Powered-By', (0, _util.packageIdentifier)());
      }

      // Lastly, send the response
      res.send(responseOptions.content || '');
    };
  }

  function handleError(error, res, next) {
    if (adapter.expressPropagateErrors) {
      next(error);
    }
    var respond = sendResponse(res);
    if (adapter.waitForResponse) {
      adapter.emit('error', error, respond);
    } else {
      adapter.emit('error', error);
      respond(error);
    }
  }

  // eslint-disable-next-line no-param-reassign
  adapter.middleware = function slackEventAdapterMiddlware(req, res, next) {
    // Check that the request body has been parsed
    if (!req.body) {
      var error = new Error('The incoming HTTP request did not have a parsed body.');
      error.code = errorCodes.NO_BODY_PARSER;
      handleError(error, res, next);
      return;
    }

    // Handle event challenge
    if (req.body.type === 'url_verification') {
      if (req.body.token !== adapter.verificationToken) {
        var _error = new Error('Slack event challenge failed.');
        _error.code = errorCodes.TOKEN_VERIFICATION_FAILURE;
        _error.body = req.body;
        handleError(_error, res, next);
        return;
      }
      sendResponse(res)(null, { content: req.body.challenge });
      return;
    }

    // Handle event token verification
    if (req.body.token && req.body.token !== adapter.verificationToken) {
      var _error2 = new Error('Slack event verification failed');
      _error2.code = errorCodes.TOKEN_VERIFICATION_FAILURE;
      _error2.body = req.body;
      handleError(_error2, res, next);
      return;
    }

    // TODO: expose whether this is a retry and what the retry reason would be
    var emitArguments = [req.body.event];
    if (adapter.includeRawBody) {
      emitArguments.push(req.body);
    }
    if (adapter.waitForResponse) {
      emitArguments.push(sendResponse(res));
    }
    try {
      adapter.emit.apply(adapter, [req.body.event.type].concat(emitArguments));
    } catch (error) {
      adapter.emit('error', error);
    }

    if (!adapter.waitForResponse) {
      sendResponse(res)();
    }
  };
}

exports.default = {
  bindMiddlewareToAdapter: bindMiddlewareToAdapter
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWRkbGV3YXJlLmpzIl0sIm5hbWVzIjpbImVycm9yQ29kZXMiLCJOT19CT0RZX1BBUlNFUiIsIlRPS0VOX1ZFUklGSUNBVElPTl9GQUlMVVJFIiwicmVzcG9uc2VTdGF0dXNlcyIsIk9LIiwiRkFJTFVSRSIsIlJFRElSRUNUIiwiYmluZE1pZGRsZXdhcmVUb0FkYXB0ZXIiLCJhZGFwdGVyIiwic2VuZFJlc3BvbnNlIiwicmVzIiwiX3NlbmRSZXNwb25zZSIsImVyciIsInJlc3BvbnNlT3B0aW9ucyIsInN0YXR1cyIsImZhaWxXaXRoTm9SZXRyeSIsInJlZGlyZWN0TG9jYXRpb24iLCJzZXQiLCJzZW5kIiwiY29udGVudCIsImhhbmRsZUVycm9yIiwiZXJyb3IiLCJuZXh0IiwiZXhwcmVzc1Byb3BhZ2F0ZUVycm9ycyIsInJlc3BvbmQiLCJ3YWl0Rm9yUmVzcG9uc2UiLCJlbWl0IiwibWlkZGxld2FyZSIsInNsYWNrRXZlbnRBZGFwdGVyTWlkZGx3YXJlIiwicmVxIiwiYm9keSIsIkVycm9yIiwiY29kZSIsInR5cGUiLCJ0b2tlbiIsInZlcmlmaWNhdGlvblRva2VuIiwiY2hhbGxlbmdlIiwiZW1pdEFyZ3VtZW50cyIsImV2ZW50IiwiaW5jbHVkZVJhd0JvZHkiLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRU8sSUFBTUEsa0NBQWE7QUFDeEJDLGtCQUFnQixxQ0FEUTtBQUV4QkMsOEJBQTRCO0FBRkosQ0FBbkI7O0FBS1AsSUFBTUMsbUJBQW1CO0FBQ3ZCQyxNQUFJLEdBRG1CO0FBRXZCQyxXQUFTLEdBRmM7QUFHdkJDLFlBQVU7QUFIYSxDQUF6Qjs7QUFNQSxTQUFTQyx1QkFBVCxDQUFpQ0MsT0FBakMsRUFBMEM7QUFDeEMsV0FBU0MsWUFBVCxDQUFzQkMsR0FBdEIsRUFBMkI7QUFDekIsV0FBTyxTQUFTQyxhQUFULENBQXVCQyxHQUF2QixFQUFrRDtBQUFBLFVBQXRCQyxlQUFzQix1RUFBSixFQUFJOztBQUN2RDtBQUNB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QUFDQSxRQUFJOUIsUUFBUStCLGNBQVosRUFBNEI7QUFDMUJGLG9CQUFjRyxJQUFkLENBQW1CWCxJQUFJQyxJQUF2QjtBQUNEO0FBQ0QsUUFBSXRCLFFBQVFpQixlQUFaLEVBQTZCO0FBQzNCWSxvQkFBY0csSUFBZCxDQUFtQi9CLGFBQWFDLEdBQWIsQ0FBbkI7QUFDRDtBQUNELFFBQUk7QUFDRkYsY0FBUWtCLElBQVIsaUJBQWFHLElBQUlDLElBQUosQ0FBU1EsS0FBVCxDQUFlTCxJQUE1QixTQUFxQ0ksYUFBckM7QUFDRCxLQUZELENBRUUsT0FBT2hCLEtBQVAsRUFBYztBQUNkYixjQUFRa0IsSUFBUixDQUFhLE9BQWIsRUFBc0JMLEtBQXRCO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDYixRQUFRaUIsZUFBYixFQUE4QjtBQUM1QmhCLG1CQUFhQyxHQUFiO0FBQ0Q7QUFDRixHQWhERDtBQWlERDs7a0JBRWM7QUFDYkg7QUFEYSxDIiwiZmlsZSI6Im1pZGRsZXdhcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwYWNrYWdlSWRlbnRpZmllciB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCBjb25zdCBlcnJvckNvZGVzID0ge1xuICBOT19CT0RZX1BBUlNFUjogJ1NMQUNLRVZFTlRNSURETEVXQVJFX05PX0JPRFlfUEFSU0VSJyxcbiAgVE9LRU5fVkVSSUZJQ0FUSU9OX0ZBSUxVUkU6ICdTTEFDS0VWRU5UTUlERExFV0FSRV9UT0tFTl9WRVJJRklDQVRJT05fRkFJTFVSRScsXG59O1xuXG5jb25zdCByZXNwb25zZVN0YXR1c2VzID0ge1xuICBPSzogMjAwLFxuICBGQUlMVVJFOiA1MDAsXG4gIFJFRElSRUNUOiAzMDIsXG59O1xuXG5mdW5jdGlvbiBiaW5kTWlkZGxld2FyZVRvQWRhcHRlcihhZGFwdGVyKSB7XG4gIGZ1bmN0aW9uIHNlbmRSZXNwb25zZShyZXMpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gX3NlbmRSZXNwb25zZShlcnIsIHJlc3BvbnNlT3B0aW9ucyA9IHt9KSB7XG4gICAgICAvLyBEZWFsIHdpdGggZXJyb3JzIHVwIGZyb250XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlcy5zdGF0dXMocmVzcG9uc2VTdGF0dXNlcy5GQUlMVVJFKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEZpcnN0IGRldGVybWluZSB0aGUgcmVzcG9uc2Ugc3RhdHVzXG4gICAgICAgIGlmIChyZXNwb25zZU9wdGlvbnMpIHtcbiAgICAgICAgICBpZiAocmVzcG9uc2VPcHRpb25zLmZhaWxXaXRoTm9SZXRyeSkge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhyZXNwb25zZVN0YXR1c2VzLkZBSUxVUkUpO1xuICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2VPcHRpb25zLnJlZGlyZWN0TG9jYXRpb24pIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMocmVzcG9uc2VTdGF0dXNlcy5SRURJUkVDVCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlcy5zdGF0dXMocmVzcG9uc2VTdGF0dXNlcy5PSyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBOZXh0IGRldGVybWluZSB0aGUgcmVzcG9uc2UgaGVhZGVyc1xuICAgICAgICBpZiAocmVzcG9uc2VPcHRpb25zICYmIHJlc3BvbnNlT3B0aW9ucy5mYWlsV2l0aE5vUmV0cnkpIHtcbiAgICAgICAgICByZXMuc2V0KCdYLVNsYWNrLU5vLVJldHJ5JywgJzEnKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuc2V0KCdYLVNsYWNrLVBvd2VyZWQtQnknLCBwYWNrYWdlSWRlbnRpZmllcigpKTtcbiAgICAgIH1cblxuICAgICAgLy8gTGFzdGx5LCBzZW5kIHRoZSByZXNwb25zZVxuICAgICAgcmVzLnNlbmQocmVzcG9uc2VPcHRpb25zLmNvbnRlbnQgfHwgJycpO1xuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvciwgcmVzLCBuZXh0KSB7XG4gICAgaWYgKGFkYXB0ZXIuZXhwcmVzc1Byb3BhZ2F0ZUVycm9ycykge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICAgIGNvbnN0IHJlc3BvbmQgPSBzZW5kUmVzcG9uc2UocmVzKTtcbiAgICBpZiAoYWRhcHRlci53YWl0Rm9yUmVzcG9uc2UpIHtcbiAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvciwgcmVzcG9uZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvcik7XG4gICAgICByZXNwb25kKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cbiAgYWRhcHRlci5taWRkbGV3YXJlID0gZnVuY3Rpb24gc2xhY2tFdmVudEFkYXB0ZXJNaWRkbHdhcmUocmVxLCByZXMsIG5leHQpIHtcbiAgICAvLyBDaGVjayB0aGF0IHRoZSByZXF1ZXN0IGJvZHkgaGFzIGJlZW4gcGFyc2VkXG4gICAgaWYgKCFyZXEuYm9keSkge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1RoZSBpbmNvbWluZyBIVFRQIHJlcXVlc3QgZGlkIG5vdCBoYXZlIGEgcGFyc2VkIGJvZHkuJyk7XG4gICAgICBlcnJvci5jb2RlID0gZXJyb3JDb2Rlcy5OT19CT0RZX1BBUlNFUjtcbiAgICAgIGhhbmRsZUVycm9yKGVycm9yLCByZXMsIG5leHQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBldmVudCBjaGFsbGVuZ2VcbiAgICBpZiAocmVxLmJvZHkudHlwZSA9PT0gJ3VybF92ZXJpZmljYXRpb24nKSB7XG4gICAgICBpZiAocmVxLmJvZHkudG9rZW4gIT09IGFkYXB0ZXIudmVyaWZpY2F0aW9uVG9rZW4pIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1NsYWNrIGV2ZW50IGNoYWxsZW5nZSBmYWlsZWQuJyk7XG4gICAgICAgIGVycm9yLmNvZGUgPSBlcnJvckNvZGVzLlRPS0VOX1ZFUklGSUNBVElPTl9GQUlMVVJFO1xuICAgICAgICBlcnJvci5ib2R5ID0gcmVxLmJvZHk7XG4gICAgICAgIGhhbmRsZUVycm9yKGVycm9yLCByZXMsIG5leHQpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzZW5kUmVzcG9uc2UocmVzKShudWxsLCB7IGNvbnRlbnQ6IHJlcS5ib2R5LmNoYWxsZW5nZSB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgZXZlbnQgdG9rZW4gdmVyaWZpY2F0aW9uXG4gICAgaWYgKHJlcS5ib2R5LnRva2VuICYmIHJlcS5ib2R5LnRva2VuICE9PSBhZGFwdGVyLnZlcmlmaWNhdGlvblRva2VuKSB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignU2xhY2sgZXZlbnQgdmVyaWZpY2F0aW9uIGZhaWxlZCcpO1xuICAgICAgZXJyb3IuY29kZSA9IGVycm9yQ29kZXMuVE9LRU5fVkVSSUZJQ0FUSU9OX0ZBSUxVUkU7XG4gICAgICBlcnJvci5ib2R5ID0gcmVxLmJvZHk7XG4gICAgICBoYW5kbGVFcnJvcihlcnJvciwgcmVzLCBuZXh0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBleHBvc2Ugd2hldGhlciB0aGlzIGlzIGEgcmV0cnkgYW5kIHdoYXQgdGhlIHJldHJ5IHJlYXNvbiB3b3VsZCBiZVxuICAgIGNvbnN0IGVtaXRBcmd1bWVudHMgPSBbcmVxLmJvZHkuZXZlbnRdO1xuICAgIGlmIChhZGFwdGVyLmluY2x1ZGVSYXdCb2R5KSB7XG4gICAgICBlbWl0QXJndW1lbnRzLnB1c2gocmVxLmJvZHkpO1xuICAgIH1cbiAgICBpZiAoYWRhcHRlci53YWl0Rm9yUmVzcG9uc2UpIHtcbiAgICAgIGVtaXRBcmd1bWVudHMucHVzaChzZW5kUmVzcG9uc2UocmVzKSk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhZGFwdGVyLmVtaXQocmVxLmJvZHkuZXZlbnQudHlwZSwgLi4uZW1pdEFyZ3VtZW50cyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGFkYXB0ZXIuZW1pdCgnZXJyb3InLCBlcnJvcik7XG4gICAgfVxuXG4gICAgaWYgKCFhZGFwdGVyLndhaXRGb3JSZXNwb25zZSkge1xuICAgICAgc2VuZFJlc3BvbnNlKHJlcykoKTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgYmluZE1pZGRsZXdhcmVUb0FkYXB0ZXIsXG59O1xuIl19
//# sourceMappingURL=middleware.js.map